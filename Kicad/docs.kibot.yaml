kibot:
  version: 1

filters:
  - name: only_fitted_parts
    comment: 'Only parts that are not DNF'
    type: generic
    include_only:
      - column: 'DNP'
        regex: '^0'

preflight:
  set_text_variables:
    - name: "date"
      command: git log -1 --format="%as"
    - name: "version"
      command: git describe --exact-match --tags 2> /dev/null || git rev-parse --short HEAD
  update_xml: true
  run_erc: true
  run_drc: true
  check_zone_fills: true
  ignore_unconnected: false

import:
  - file: .kibot/gerbers_jlcpcb.kibot.yml

outputs:
  - name: 'generic_sch_pdf'
    comment: "Print the schematic as a PDF"
    type: pdf_sch_print
    options:
      output: '%f-%r-schematic.%x'

  - name: 'make_svg'
    comment: "Generate 2D PCB image in SVG format"
    type: pcbdraw
    options:
      output: '%f-%r-pcb.%x'

  - name: 'make_png'
    comment: "Generate 2D PCB image in PNG format"
    type: pcbdraw
    options:
      output: '%f-%r-pcb.%x'
      format: png

  - name: 'make_pcb_pdf'
    comment: "Generate 2D PCB CAD in PDF format"
    type: pdf_pcb_print
    layers:
      - F.Cu
      - In1.Cu
      - In2.Cu
      - B.Cu
      - Edge.Cuts
      - F.SilkS
      - F.Paste
      - F.Mask
      - B.SilkS
      - B.Paste
      - B.Mask
    options:
      output: '%f-%r-pcb.%x'
      separated: true
      monochrome: false

  - name: 'make_bom_html'
    comment: "Generate bill-of-material files as HTML"
    type: bom
    options:
      format: HTML
      exclude_filter: 'only_fitted_parts'
      html:
        datasheet_as_link: "Datasheet"
        digikey_link: "Digikey"
        title: "Neotron Pico Bill of Materials"
      group_fields:
        - 'Part'
        - 'Part Lib'
        - 'Value'
        - 'Voltage'
        - 'Tolerance'
        - 'Footprint'
        - 'Footprint Lib'
      columns:
        - Row
        - field: Manufacturer
          name: Part Number
          join: ['mpn']
        - References
        - Quantity per PCB
        - field: Value
          join: ['voltage', 'current', 'power', 'tolerance']
        - field: 'LCSC Part#'
          name: LCSC
        - Digikey
        - Mouser
        - Footprint
      output: '%f-%r-bom.%x'

  - name: 'make_ibom'
    comment: "Generate assembly HTML page"
    type: ibom
    options:
      output: '%f-%r-ibom.%x'
      extra_fields: "Voltage,Tolerance,Manufacturer,MPN"

  - name: 'make_octopart_bom'
    comment: 'Make a bill-of-materials you can upload to https://octopart.com/'
    type: 'kibom'
    options:
      conf:
        columns:
          - References
          - Description
          - Part
          - Value
          - field: Quantity Per PCB
            name: Qty
        component_aliases: [['r', 'r_small', 'res', 'resistor'], ['l', 'l_small', 'inductor'], ['c', 'c_small', 'cap', 'capacitor'], ['sw', 'switch'], ['zener', 'zenersmall'], ['d', 'diode', 'd_small']]
        datasheet_as_link: ''
        digikey_link: ''
        exclude_any:
          - column: Part
            regex: TestPoint
          - column: Part
            regex: LOGO
          - column: Part
            regex: Jumper
        fit_field: 'Config'
        group_connectors: true
        hide_headers: false
        hide_pcb_info: true
        html_generate_dnf: true
        ignore_dnf: true
        merge_blank_fields: false
        number_rows: false
        test_regex: true
        use_alt: false
      format: 'CSV'
      number: 1
      output: '%f-%r-bom-octopart.%x'
      separator: ';'
      variant: ''

  - name: 'make_jlcpcb_zip'
    type: compress
    dir: .
    options:
      format: ZIP
      files:
        - dest: .
          source: gerbers/jlcpcb/*
      move_files: true
      output: '%f-%r-gerbers-jlcpcb.%x'
